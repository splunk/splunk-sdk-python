name: Run test suite

on: [push, workflow_dispatch]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-22.04
          # - ubuntu-latest
        python-version:
          - 3.7
          # - 3.9
          # - 3.13
        splunk-version:
          - "9.3"
          # - "9.4"
          # - "latest"

      fail-fast: false
    steps:
      - name: Checkout repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Set up environment variables
        run: cp ./.env.test ./.env
      - name: Launch Splunk ${{ matrix.splunk-version }}
        run: SPLUNK_VERSION=${{ matrix.splunk-version }} docker compose up -d
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install dependencies
        run: type -a python && python -m pip install tox
      - name: Run Docker health check
        # Probably solves nothing, worth trying regardless
        run: |
          timeout 30s make wait_up
          if [ $? -eq 124 ]; then
            echo "Splunk failed to start within 30 seconds."
            docker compose logs
            exit 1
          fi
      - name: Run test suite
        run: type -a python && python -m tox -e py
      - name: Print docker logs for optional inspection
        run: docker compose logs
# [BJ] I'll uncomment this step after I finish fiddling
#  fossa-scan:
#    uses: splunk/oss-scanning-public/.github/workflows/oss-scan.yml@main
#    secrets: inherit
